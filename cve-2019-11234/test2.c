#include <stdio.h>
#include <openssl/bn.h>
#include <openssl/sha.h>
#include <openssl/ec.h>
#include <openssl/evp.h>
#include <openssl/hmac.h>

void print_point(char *prefix, EC_GROUP *group, EC_POINT *p, BN_CTX *bnctx) {
    BIGNUM *x = BN_new();
    BIGNUM *y = BN_new();
    char *x_str = NULL;
    char *y_str = NULL;

    if (prefix != NULL) {
        printf("%s", prefix);
    }

    if (EC_POINT_is_at_infinity(group, p)) {
        printf("{0}");
        if (prefix != NULL) {
            printf("\n");
        }
        return;
    }

    if (!EC_POINT_get_affine_coordinates_GFp(group, p, x, y, bnctx)) {
        printf("Unable to get curve points for printing!");
        exit(1);
    }

    x_str = BN_bn2hex(x);
    y_str = BN_bn2hex(y);

    // printf("(%s, %s)", x_str, y_str);
    printf("(%s)", x_str);
    if (prefix != NULL) {
        printf("\n");
    }

    free(x_str);
    free(y_str);
}



int main() {
    BN_CTX *bnctx = BN_CTX_new();
    EC_GROUP *group = EC_GROUP_new_by_curve_name(NID_X9_62_prime256v1);

    int at_infty = 0;

do {
    EC_POINT *K = EC_POINT_new(group);
    EC_POINT *PWE = EC_GROUP_get0_generator(group);
    EC_POINT *Element_P = EC_POINT_new(group);

    uint8_t *zeros = calloc(32, sizeof(uint8_t));

    BIGNUM *x = BN_new();
    BN_bin2bn(zeros, 32, x);
    BIGNUM *y = BN_new();
    BN_bin2bn(zeros, 32, y);

    BIGNUM *zero = BN_new();
    BN_zero(zero);

    if (!EC_POINT_set_affine_coordinates_GFp(group, Element_P, x, y, bnctx)) {
        printf("Error: unable to set points.\n");
        return 2;
    }

    print_point("K", group, K, bnctx);
    print_point("PWE", group, PWE, bnctx);
    print_point("Element_P", group, Element_P, bnctx);

    if (!EC_POINT_mul(group, K, NULL, PWE, zero, bnctx)) {
        printf("Error: unable to multiply points.\n");
        return 2;
    }

    if (!EC_POINT_add(group, K, K, Element_P, bnctx)) {
        printf("Error: unable to add points.\n");
        return 2;
    }

    at_infty = EC_POINT_is_at_infinity(group, K);
    printf("end: is_at_infinity: %d\n", at_infty);
} while(at_infty);

    return at_infty;
}

