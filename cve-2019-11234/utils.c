#include "eap-pwd.h"

BIGNUM *get_random_max(BIGNUM *max) {
    BIGNUM *random_scalar = BN_new();
    if (BN_rand_range(random_scalar, max) != 1) {
        ERROR("Unable to get a random number in the range!");
        return NULL;
    }

    return random_scalar;
}

EC_POINT *get_random_EC_POINT(EC_GROUP *group, BIGNUM *order, BN_CTX *bnctx) {
    BIGNUM *random_scalar = get_random_max(order);

    EC_POINT *random_point = EC_POINT_new(group);
    if (!EC_POINT_mul(group, random_point, random_scalar, NULL, NULL, bnctx)) {
        ERROR("Error performing point multiplication!");
        free(random_scalar);
        return NULL;
    }

    free(random_scalar);
    return random_point;
}

EC_POINT *get_point_from_hex(EC_GROUP *group, char *x_repr, char *y_repr, BN_CTX *bnctx) {
    BIGNUM *x = BN_new();
    BIGNUM *y = BN_new();

    if (BN_hex2bn(&x, x_repr) == 0) {
        ERROR("Error parsing x's representation!");
        exit(1);
    }

    if (BN_hex2bn(&y, y_repr) == 0) {
        ERROR("Error parsing y's representation!");
        exit(1);
    }

    EC_POINT *result = EC_POINT_new(group);
    if (!EC_POINT_set_affine_coordinates_GFp(group, result, x, y, bnctx)) {
        ERROR("Error setting affine coordinates on point!");
        exit(1);
    }

    return result;
}

void print_bn(char *prefix, BIGNUM *num) {
    char *str = BN_bn2hex(num);
    if (prefix != NULL) {
        printf("%s", prefix);
    }
    printf("%s", str);
    if (prefix != NULL) {
        printf("\n");
    }
    free(str);
}

void print_point(char *prefix, EC_GROUP *group, EC_POINT *p, BN_CTX *bnctx) {
    BIGNUM *x = BN_new();
    BIGNUM *y = BN_new();
    char *x_str = NULL;
    char *y_str = NULL;

    if (prefix != NULL) {
        printf("%s", prefix);
    }

    if (EC_POINT_is_at_infinity(group, p)) {
        printf("{0}");
        if (prefix != NULL) {
            printf("\n");
        }
        return;
    }

    if (!EC_POINT_get_affine_coordinates_GFp(group, p, x, y, bnctx)) {
        ERROR("Unable to get curve points for printing!");
        exit(1);
    }

    x_str = BN_bn2hex(x);
    y_str = BN_bn2hex(y);

    // printf("(%s, %s)", x_str, y_str);
    printf("(%s)", x_str);
    if (prefix != NULL) {
        printf("\n");
    }

    free(x_str);
    free(y_str);
}

BIGNUM *compute_eap_pwd_scalar(BIGNUM *rand, BIGNUM *mask, BIGNUM *order, BN_CTX *bnctx) {
    BIGNUM *result = BN_new();
    BN_add(result, rand, mask);
    BN_mod(result, result, order, bnctx);

    return result;
}

EC_POINT *compute_eap_pwd_element(EC_POINT *pwe, BIGNUM *mask, EC_GROUP *group, BN_CTX *bnctx) {
    EC_POINT *result = EC_POINT_new(group);

    if (!EC_POINT_mul(group, result, NULL, pwe, mask, bnctx)) {
        ERROR("Server element allocation failed");
        exit(1);
    }

    if (!EC_POINT_invert(group, result, bnctx)) {
        ERROR("Server element inversion failed");
        exit(1);
    }

    return result;
}

uint8_t *encode_attack(size_t *ret_len, EC_GROUP *group, BIGNUM *order,
        BIGNUM *prime, EC_POINT *element_p, BIGNUM *scalar_p, BN_CTX *bnctx)
{
    uint8_t *result = NULL;
    uint8_t *ptr = NULL;
    size_t offset = 0;

    if (ret_len == NULL || group == NULL || order == NULL || prime == NULL ||
            element_p == NULL || scalar_p == NULL || bnctx == NULL)
    {
        ERROR("Must pass ret_len to encode_attack!");
        exit(1);
    }

    BIGNUM *x = BN_new();
    BIGNUM *y = BN_new();

    if (EC_POINT_is_at_infinity(group, element_p)) {
        BN_zero(x);
        BN_zero(y);
    } else if (!EC_POINT_get_affine_coordinates_GFp(group, element_p, x, y, bnctx)) {
        ERROR("Unable to get curve points for printing!");
        exit(1);
    }

    *ret_len = (size_t)(BN_num_bytes(order) + (2 * BN_num_bytes(prime)));
    result = calloc(*ret_len, sizeof(uint8_t));
    if (result == NULL) {
        ERROR("Unable to allocate memory!");
        exit(1);
    }

    ptr = result;
    offset = BN_num_bytes(prime) - BN_num_bytes(x);
    BN_bn2bin(x, ptr + offset);
    BN_clear_free(x);

    ptr += BN_num_bytes(prime);
    offset = BN_num_bytes(prime) - BN_num_bytes(y);
    BN_bn2bin(y, ptr + offset);
    BN_clear_free(y);

    ptr += BN_num_bytes(prime);
    offset = BN_num_bytes(order) - BN_num_bytes(scalar_p);
    BN_bn2bin(scalar_p, ptr + offset);


    return result;
}

void print_debug(int result, pwd_session_t *session, EC_POINT *element_p,
        BIGNUM *scalar_p, BN_CTX *bnctx)
{
    BIGNUM *zero = BN_new();
    BN_zero(zero);

    BIGNUM *one = BN_new();
    BN_one(one);

    BIGNUM *two = BN_new();
    BN_set_word(two, 2);

    BIGNUM *three = BN_new();
    BN_set_word(three, 3);

    BIGNUM *four = BN_new();
    BN_set_word(four, 4);

    printf("\n\nResult: %d\n", result);
    if (result != 0) {
        return;
    }

    BIGNUM *neg_scalar_s = BN_new();
    BN_sub(neg_scalar_s, session->order, session->my_scalar);

    BIGNUM *neg_scalar_p = BN_new();
    BN_sub(neg_scalar_p, session->order, scalar_p);

    print_bn("\tprime: ", session->prime);
    print_bn("\torder: ", session->order);
    print_point("\tPWE: ", session->group, session->pwe, bnctx);
    print_bn("\ts_rand / private_value: ", session->private_value);
    print_bn("\ts_mask: ", session->private_value);
    print_bn("\tscalar_s / my_scalar: ", session->my_scalar);
    print_bn("\t-scalar_s / -my_scalar: ", neg_scalar_s);
    print_point("\telement_s / my_element: ",  session->group, session->my_element, bnctx);
    print_bn("\tscalar_p / peer_scalar: ", scalar_p);
    print_bn("\t-scalar_p / -peer_scalar: ", neg_scalar_p);
    print_point("\telement_p / peer_element: ", session->group, element_p, bnctx);

    printf("\n\nTarget value:\n");
    if (result == 0) {
        print_bn("ks / session.k: ", session->k);
    }

    printf("\n\n\tMagical values:\n");

    EC_POINT *aG = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, aG, session->private_value, NULL, NULL, bnctx);
    print_point("\t\ts_rand * G: ", session->group, aG, bnctx);

    EC_POINT *aA = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, aA, NULL, session->my_element, session->private_value, bnctx);
    print_point("\t\ts_rand * Element_S: ", session->group, aA, bnctx);

    EC_POINT *aB = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, aB, NULL, element_p, session->private_value, bnctx);
    print_point("\t\ts_rand * Element_P: ", session->group, aB, bnctx);

    EC_POINT *aPWE = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, aPWE, NULL, session->pwe, session->private_value, bnctx);
    print_point("\t\ts_rand * PWE: ", session->group, aPWE, bnctx);

    printf("\n");

    EC_POINT *bG = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, bG, session->my_scalar, NULL, NULL, bnctx);
    print_point("\t\tscalar_s * G: ", session->group, bG, bnctx);

    EC_POINT *bA = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, bA, NULL, session->my_element, session->my_scalar, bnctx);
    print_point("\t\tscalar_s * Element_S: ", session->group, bA, bnctx);

    EC_POINT *bB = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, bB, NULL, element_p, session->my_scalar, bnctx);
    print_point("\t\tscalar_s * Element_P: ", session->group, bB, bnctx);

    EC_POINT *bPWE = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, bPWE, NULL, session->pwe, session->my_scalar, bnctx);
    print_point("\t\tscalar_s * PWE: ", session->group, bPWE, bnctx);

    printf("\n");

    EC_POINT *cG = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, cG, scalar_p, NULL, NULL, bnctx);
    print_point("\t\tscalar_p * G: ", session->group, cG, bnctx);

    EC_POINT *cA = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, cA, NULL, session->my_element, scalar_p, bnctx);
    print_point("\t\tscalar_p * Element_S: ", session->group, cA, bnctx);

    EC_POINT *cB = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, cB, NULL, element_p, scalar_p, bnctx);
    print_point("\t\tscalar_p * Element_P: ", session->group, cB, bnctx);

    EC_POINT *cPWE = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, cPWE, NULL, session->pwe, scalar_p, bnctx);
    print_point("\t\tscalar_p * PWE: ", session->group, cPWE, bnctx);

    printf("\n");

    EC_POINT *dG = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, dG, neg_scalar_s, NULL, NULL, bnctx);
    print_point("\t\t-scalar_s * G: ", session->group, dG, bnctx);

    EC_POINT *dA = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, dA, NULL, session->my_element, neg_scalar_s, bnctx);
    print_point("\t\t-scalar_s * Element_S: ", session->group, dA, bnctx);

    EC_POINT *dB = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, dB, NULL, element_p, neg_scalar_s, bnctx);
    print_point("\t\t-scalar_s * Element_P: ", session->group, dB, bnctx);

    EC_POINT *dPWE = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, dPWE, NULL, session->pwe, neg_scalar_s, bnctx);
    print_point("\t\t-scalar_s * PWE: ", session->group, dPWE, bnctx);

    printf("\n");

    EC_POINT *eG = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, eG, neg_scalar_p, NULL, NULL, bnctx);
    print_point("\t\t-scalar_p * G: ", session->group, eG, bnctx);

    EC_POINT *eA = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, eA, NULL, session->my_element, neg_scalar_p, bnctx);
    print_point("\t\t-scalar_p * Element_S: ", session->group, eA, bnctx);

    EC_POINT *eB = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, eB, NULL, element_p, neg_scalar_p, bnctx);
    print_point("\t\t-scalar_p * Element_P: ", session->group, eB, bnctx);

    EC_POINT *ePWE = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, ePWE, NULL, session->pwe, neg_scalar_p, bnctx);
    print_point("\t\t-scalar_p * PWE: ", session->group, ePWE, bnctx);

    printf("\n");

    EC_POINT *B0 = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, B0, NULL, element_p, zero, bnctx);
    print_point("\t\t0 * Element_P: ", session->group, B0, bnctx);

    EC_POINT *B1 = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, B1, NULL, element_p, one, bnctx);
    print_point("\t\t1 * Element_P: ", session->group, B1, bnctx);

    EC_POINT *B2 = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, B2, NULL, element_p, two, bnctx);
    print_point("\t\t2 * Element_P: ", session->group, B2, bnctx);

    EC_POINT *B3 = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, B3, NULL, element_p, three, bnctx);
    print_point("\t\t3 * Element_P: ", session->group, B3, bnctx);

    EC_POINT *B4 = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, B4, NULL, element_p, four, bnctx);
    print_point("\t\t4 * Element_P: ", session->group, B4, bnctx);

    printf("\n");

    EC_POINT *nA = EC_POINT_new(session->group);
    EC_POINT_mul(session->group, nA, NULL, element_p, neg_scalar_s, bnctx);
    print_point("\t\t-scalar_s * Element_A: ", session->group, nA, bnctx);

    EC_POINT *nAA = EC_POINT_new(session->group);
    EC_POINT_add(session->group, nAA, nA, element_p, bnctx);
    print_point("\t\t-scalar_s * Element_A + Element_A: ", session->group, nAA, bnctx);
}
